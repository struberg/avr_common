/*
 * Copyright 2018-2024 Mark Struberg
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include "font_proportional.h"
#include "tile_8x8.h"

#include <avr/pgmspace.h>

/**
 * @brief 8x8 proportional font
 * 
 */
 PROGMEM const Tile font_prop_8x8 []= {
    {0x37,{0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0}},	// SP
    {0x7,{0x80,0x80,0x80,0x80,0x80,0x0,0x80,0x0}},	// !
    {0x27,{0xA0,0xA0,0x0,0x0,0x0,0x0,0x0,0x0}},	// "
    {0x47,{0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x0}},	// #
    {0x47,{0x70,0xA8,0xA0,0x70,0x28,0xA8,0x70,0x20}},	// $
    {0x47,{0xC8,0xC8,0x10,0x20,0x40,0x98,0x98,0x0}},	// %
    {0x47,{0x60,0x90,0x60,0x60,0xB0,0x98,0x68,0x0}},	// &
    {0x7,{0x80,0x80,0x0,0x0,0x0,0x0,0x0,0x0}},	// '
    {0x17,{0x40,0x80,0x80,0x80,0x80,0x80,0x40,0x0}},	// (
    {0x17,{0x80,0x40,0x40,0x40,0x40,0x40,0x80,0x0}},	// )
    {0x47,{0x0,0x20,0xA8,0x70,0xA8,0x20,0x0,0x0}},	// *
    {0x27,{0x0,0x0,0x40,0xE0,0x40,0x0,0x0,0x0}},	// +
    {0x17,{0x0,0x0,0x0,0x0,0x0,0x40,0x40,0x80}},	// ,
    {0x27,{0x0,0x0,0x0,0xE0,0x0,0x0,0x0,0x0}},	// -
    {0x7,{0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x0}},	// .
    {0x37,{0x10,0x30,0x20,0x60,0x40,0xC0,0x80,0x0}},	// /
    {0x37,{0x60,0x90,0xB0,0xF0,0xD0,0x90,0x60,0x0}},	// 0
    {0x37,{0x20,0x60,0xE0,0xA0,0x20,0x20,0xF0,0x0}},	// 1
    {0x47,{0x70,0xF8,0x98,0x30,0x60,0xC0,0xF8,0x0}},	// 2
    {0x37,{0x60,0x90,0x10,0x20,0x10,0x90,0x60,0x0}},	// 3
    {0x37,{0x10,0x30,0x60,0xC0,0xF0,0x20,0x20,0x0}},	// 4
    {0x37,{0xF0,0x80,0x80,0xE0,0x10,0x90,0x60,0x0}},	// 5
    {0x37,{0x60,0x90,0x80,0xE0,0x90,0x90,0x60,0x0}},	// 6
    {0x37,{0xF0,0x30,0x20,0x60,0x40,0xC0,0xC0,0x0}},	// 7
    {0x37,{0x60,0x90,0x90,0x60,0x90,0x90,0x60,0x0}},	// 8
    {0x37,{0x60,0x90,0x90,0x70,0x10,0x90,0x60,0x0}},	// 9
    {0x7,{0x0,0x0,0x0,0x80,0x0,0x80,0x0,0x0}},	// :
    {0x17,{0x0,0x0,0x0,0x40,0x0,0x40,0x40,0x80}},	// ;
    {0x27,{0x0,0x20,0x40,0x80,0x40,0x20,0x0,0x0}},	// <
    {0x27,{0x0,0x0,0xE0,0x0,0xE0,0x0,0x0,0x0}},	// =
    {0x27,{0x0,0x80,0x40,0x20,0x40,0x80,0x0,0x0}},	// >
    {0x27,{0x40,0xA0,0x20,0x40,0x40,0x0,0x40,0x0}},	// ?
    {0x57,{0x38,0x44,0x94,0xAC,0x9C,0x40,0x38,0x0}},	// @
    {0x27,{0x40,0xA0,0xB0,0xF0,0xA0,0xB0,0xB0,0x0}},	// A
    {0x27,{0xC0,0xA0,0xA0,0xC0,0xA0,0xA0,0xC0,0x0}},	// B
    {0x27,{0x40,0xA0,0x80,0x80,0x80,0xA0,0x40,0x0}},	// C
    {0x27,{0xC0,0xA0,0xA0,0xA0,0xA0,0xA0,0xC0,0x0}},	// D
    {0x27,{0xE0,0x80,0x80,0xE0,0x80,0x80,0xE0,0x0}},	// E
    {0x27,{0xE0,0x80,0x80,0xE0,0x80,0x80,0x80,0x0}},	// F
    {0x37,{0x60,0x90,0x80,0xB0,0x90,0x90,0x70,0x0}},	// G
    {0x27,{0xA0,0xA0,0xA0,0xE0,0xA0,0xA0,0xA0,0x0}},	// H
    {0x27,{0xE0,0x40,0x40,0x40,0x40,0x40,0xE0,0x0}},	// I
    {0x27,{0xE0,0x20,0x20,0x20,0x20,0xA0,0x40,0x0}},	// J
    {0x37,{0x90,0xB0,0xE0,0xC0,0xC0,0xA0,0x90,0x0}},	// K
    {0x27,{0x80,0x80,0x80,0x80,0x80,0x80,0xE0,0x0}},	// L
    {0x47,{0x88,0xD8,0xA8,0x88,0x88,0x88,0x88,0x0}},	// M
    {0x47,{0x88,0xC8,0xE8,0xA8,0xB8,0x98,0x88,0x0}},	// N
    {0x47,{0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x0}},	// O
    {0x37,{0xE0,0x90,0x90,0xE0,0x80,0x80,0x80,0x0}},	// P
    {0x47,{0x60,0x90,0x90,0x90,0x90,0xB0,0x70,0x8}},	// Q
    {0x37,{0xE0,0x90,0x90,0xE0,0xC0,0xA0,0x90,0x0}},	// R
    {0x37,{0x60,0x90,0x80,0x60,0x10,0x90,0x60,0x0}},	// S
    {0x27,{0xE0,0x40,0x40,0x40,0x40,0x40,0x40,0x0}},	// T
    {0x37,{0x90,0x90,0x90,0x90,0x90,0x90,0x60,0x0}},	// U
    {0x47,{0x88,0x88,0xD8,0x50,0x70,0x20,0x20,0x0}},	// V
    {0x67,{0x82,0x82,0x92,0x54,0x54,0x7C,0x28,0x0}},	// W
    {0x47,{0x88,0x88,0x50,0x20,0x50,0x88,0x88,0x0}},	// X
    {0x47,{0x88,0xD8,0x70,0x20,0x20,0x20,0x20,0x0}},	// Y
    {0x47,{0xF8,0x8,0x10,0x20,0x40,0x80,0xF8,0x0}},	// Z
    {0x17,{0xC0,0x80,0x80,0x80,0x80,0x80,0xC0,0x0}},	// [
    {0x37,{0x80,0xC0,0x40,0x60,0x20,0x30,0x10,0x0}},	// backslash
    {0x17,{0xC0,0x40,0x40,0x40,0x40,0x40,0xC0,0x0}},	// ]
    {0x27,{0x40,0xA0,0x0,0x0,0x0,0x0,0x0,0x0}},	// ^
    {0x37,{0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xF0}},	// _
    {0x17,{0x80,0x80,0x40,0x0,0x0,0x0,0x0,0x0}},	// `
    {0x37,{0x0,0x0,0xE0,0x10,0x70,0xB0,0x50,0x0}},	// a
    {0x27,{0x80,0x80,0xC0,0xA0,0xA0,0xA0,0xC0,0x0}},	// b
    {0x27,{0x0,0x0,0x60,0x80,0x80,0x80,0x60,0x0}},	// c
    {0x27,{0x20,0x20,0x60,0xA0,0xA0,0xA0,0x60,0x0}},	// d
    {0x37,{0x0,0x0,0x60,0x90,0xF0,0x80,0x70,0x0}},	// e
    {0x17,{0x40,0x80,0x80,0xC0,0x80,0x80,0x80,0x0}},	// f
    {0x37,{0x0,0x0,0x70,0x90,0x90,0x70,0x10,0x60}},	// g
    {0x27,{0x80,0x80,0xC0,0xA0,0xA0,0xA0,0xA0,0x0}},	// h
    {0x7,{0x80,0x0,0x80,0x80,0x80,0x80,0x80,0x0}},	// i
    {0x17,{0x40,0x0,0x40,0x40,0x40,0x40,0x40,0x80}},	// j
    {0x27,{0x80,0x80,0x80,0xA0,0xC0,0xC0,0xA0,0x0}},	// k
    {0x17,{0x80,0x80,0x80,0x80,0x80,0x80,0x40,0x0}},	// l
    {0x47,{0x0,0x0,0xD0,0xA8,0xA8,0xA8,0xA8,0x0}},	// m
    {0x27,{0x0,0x0,0xC0,0xA0,0xA0,0xA0,0xA0,0x0}},	// n
    {0x27,{0x0,0x0,0x40,0xA0,0xA0,0xA0,0x40,0x0}},	// o
    {0x27,{0x0,0x0,0xC0,0xA0,0xA0,0xA0,0xC0,0x80}},	// p
    {0x27,{0x0,0x0,0x60,0xA0,0xA0,0xA0,0x60,0x20}},	// q
    {0x27,{0x0,0x0,0xC0,0xA0,0x80,0x80,0x80,0x0}},	// r
    {0x27,{0x0,0x0,0x60,0x80,0x40,0x20,0xC0,0x0}},	// s
    {0x17,{0x80,0xC0,0x80,0x80,0x80,0x80,0x40,0x0}},	// t
    {0x27,{0x0,0x0,0xA0,0xA0,0xA0,0xA0,0x40,0x0}},	// u
    {0x27,{0x0,0x0,0xA0,0xA0,0xA0,0x40,0x40,0x0}},	// v
    {0x47,{0x0,0x0,0xA8,0xA8,0xA8,0x50,0x50,0x0}},	// w
    {0x27,{0x0,0x0,0x0,0xA0,0x40,0x40,0xA0,0x0}},	// x
    {0x27,{0x2,0x2,0xA3,0xA0,0xA0,0x60,0x20,0xC0}},	// y
    {0x37,{0x0,0x0,0xF0,0x20,0x40,0x80,0xF0,0x0}},	// z
    {0x27,{0x60,0x40,0x40,0x80,0x40,0x40,0x60,0x0}},	// {
    {0x7,{0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x0}},	// |
    {0x27,{0xC0,0x40,0x40,0x20,0x40,0x40,0xC0,0x0}},	// }
    {0x37,{0x0,0x0,0x0,0x50,0xA0,0x0,0x0,0x0}},	// ~
    {0x37,{0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x0}},	// BK
};


void fontp_loadCharTile(uint8_t c, Tile* pTile) {
    if (c < 32 || c > 127) {
        c = 127; // the block carret
    }

    const Tile* font = font_prop_8x8 + (c-32);
    uint8_t* pBytes = (uint8_t*) font;
    pTile->size = pgm_read_byte(pBytes);

    pBytes++; // now on to the bytes
    for (int i=0; i<8; i++) {
        pTile->bytes[i] = pgm_read_byte(pBytes + i);
    }
}

bool fontp_collide(Tile* pFirstChar, Tile* pSecondChar) {
    uint8_t lastRowF = 0;
    uint8_t firstRowS = 0;

    // e.g 0b 0011_0111 -> 0b 0000_0011
    uint8_t firstCharBitMap = (0x80>> ((pFirstChar->size & 0x70) >> 4));

    for (uint8_t i=0; i<8; i++) {
        if ((pFirstChar->bytes[i] & firstCharBitMap) != 0) {
            lastRowF |= 0x80 >> i;
        }
        if ((pSecondChar->bytes[i] & 0x80) != 0) {
            firstRowS |= 0x80 >> i;
        }
    }

    // we duplicate each pixel in one of the two rows to ensure more spacing
    lastRowF |= lastRowF << 1; 
    lastRowF |= lastRowF >> 1; 

    return (lastRowF & firstRowS) != 0;
}